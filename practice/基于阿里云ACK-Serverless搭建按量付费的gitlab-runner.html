<!DOCTYPE html><html><head><meta charset="utf-8"><title>基于阿里云ACK Serverless搭建按量付费的gitlab-runner | Congzhou&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="ACK Serverless,gitlab"><meta name="description" content="方案说明◆ 由于 CI&#x2F;CD 的非持续运行而运行期间又需要较高系统资源的特性，符合 ACK Serverless 按资源使用时间计费的场景，降低 CI&#x2F;CD 成本的同时又能提高并行多任务的执行效率。◆ 方案的系统结构与流程如下面来自参考文档[1]的截图，当没有任务时仅 gitlab-runner 作为一个 pod 始终运行，以随时接受来自 gitlab 的任务分配。当有任务需要"><meta property="og:type" content="article"><meta property="og:title" content="基于阿里云ACK Serverless搭建按量付费的gitlab-runner"><meta property="og:url" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner.html"><meta property="og:site_name" content="Congzhou&#39;s Blog"><meta property="og:description" content="方案说明◆ 由于 CI&#x2F;CD 的非持续运行而运行期间又需要较高系统资源的特性，符合 ACK Serverless 按资源使用时间计费的场景，降低 CI&#x2F;CD 成本的同时又能提高并行多任务的执行效率。◆ 方案的系统结构与流程如下面来自参考文档[1]的截图，当没有任务时仅 gitlab-runner 作为一个 pod 始终运行，以随时接受来自 gitlab 的任务分配。当有任务需要"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/structure_and_process.png"><meta property="og:image" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/secret_in_workbench.png"><meta property="og:image" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/cache_path_in_configmap.png"><meta property="og:image" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/pv_and_pvc_in_workbench.png"><meta property="og:image" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/imagecache_in_configmap.png"><meta property="og:image" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/imagecache_in_deployment.png"><meta property="og:image" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/imagecache_in_workbench.png"><meta property="og:image" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/configmap_in_workbench.png"><meta property="og:image" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/pods_in_workbench.png"><meta property="article:published_time" content="2024-07-28T13:42:01.000Z"><meta property="article:modified_time" content="2025-03-19T13:37:34.701Z"><meta property="article:author" content="Congzhou"><meta property="article:tag" content="ACK Serverless"><meta property="article:tag" content="gitlab"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://congzhou09.github.io/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/structure_and_process.png"><link rel="alternate" type="application/atom+xml" title="Congzhou&#39;s Blog" href="/atom.xml"><link rel="shortcut icon" href="/tiger.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/lib/fancybox.css"><script>window.lazyScripts=[]</script><script src="/js/av-min.js"></script><script src="/js/util.min.js"></script><script src="/js/fancybox.umd.js"></script><meta name="generator" content="Hexo 7.2.0"></head><body><script>var VISIT_INFO={};defineObserveKey(VISIT_INFO,"totalPV"),defineObserveKey(VISIT_INFO,"curPagePV"),defineObserveKey(VISIT_INFO,"totalUV")</script><div id="loading" class="active"></div><aside id="menu"><div class="inner flex-row-vertical"><div class="brand-wrap"><img class="brand-wrap-img" finalsrc="/img/brand.jpg" src="/img/brand-loading.jpg" alt="brandBackground"><div class="brand"><a href="/" class="avatar waves-effect waves-circle waves-light"><img finalsrc="/img/avatar.jpg" src="/img/avatar-loading.jpg" style="width:100%" alt="avatar"></a><hgroup class="introduce"><div class="nickname" style="margin-left:5px">Congzhou</div><div class="mail"><span class="iconfont icon-youxiang" style="vertical-align:middle"></span><span>congzhou09@gmail.com</span></div><div class="github-link"><a target="_blank" href="https://github.com/congzhou09"><span class="iconfont icon-ic-github"></span>GitHub主页</a></div></hgroup><div class="hint-container"></div></div></div><div class="scroll-wrap flex-col"><ul class="nav"><li class="waves-block waves-effect"><a href="/"><i class="iconfont icon icon-home" style="font-size:24px"></i>主页</a></li><li class="waves-block waves-effect"><a href="/archives"><i class="iconfont icon icon-archive" style="font-size:24px"></i>归档</a></li><li class="waves-block waves-effect"><a href="/tags"><i class="iconfont icon icon-tags" style="font-size:24px"></i>标签</a></li><li class="waves-block waves-effect"><a href="/categories"><i class="iconfont icon icon-categoryselected" style="font-size:24px"></i>分类</a></li></ul></div></div></aside><main id="main"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" style="text-decoration:none" id="menu-toggle"><span class="iconfont icon-menu" style="font-size:21px;font-weight:700"></span></a><div class="flex-col header-title ellipsis">基于阿里云ACK Serverless搭建按量付费的gitlab-runner</div><div class="search-wrap" id="search-wrap"><input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" style="text-decoration:none" id="search"><span class="iconfont icon-search" style="font-size:24px;font-weight:700"></span></a></div></div></header><header class="content-header post-header"><div class="container fade-scale"><h2 class="title">基于阿里云ACK Serverless搭建按量付费的gitlab-runner</h2><h5 class="subtitle"><time datetime="2024-07-28T13:42:01.000Z" itemprop="datePublished" class="page-time">2024-07-28</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/practice/">实践总结</a></li></ul></h5></div></header><div class="container body-wrap"><aside class="post-widget"><nav class="post-toc-wrap" id="post-toc"><h4>目录</h4><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%96%B9%E6%A1%88%E8%AF%B4%E6%98%8E"><span class="post-toc-number">1.</span><span class="post-toc-text">方案说明</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="post-toc-number">2.</span><span class="post-toc-text">步骤</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%87%86%E5%A4%87-ACK-Serverless-%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83"><span class="post-toc-number">2.1.</span><span class="post-toc-text">准备 ACK Serverless 集群环境</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%87%86%E5%A4%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="post-toc-number">2.2.</span><span class="post-toc-text">准备配置文件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#secret"><span class="post-toc-number">2.2.1.</span><span class="post-toc-text">secret</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E9%85%8D%E7%BD%AE-cache"><span class="post-toc-number">2.2.2.</span><span class="post-toc-text">配置 cache</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E9%85%8D%E7%BD%AE-image-cache"><span class="post-toc-number">2.2.3.</span><span class="post-toc-text">配置 image-cache</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E9%85%8D%E7%BD%AE-ConfigMap"><span class="post-toc-number">2.2.4.</span><span class="post-toc-text">配置 ConfigMap</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BD%BF%E7%94%A8-deployment-%E9%83%A8%E7%BD%B2-gitlab-runner-%E9%9B%86%E7%BE%A4"><span class="post-toc-number">2.3.</span><span class="post-toc-text">使用 deployment 部署 gitlab-runner 集群</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%85%8D%E7%BD%AE-gitlab-pipeline-%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98%E4%B8%8E%E5%A4%84%E7%90%86"><span class="post-toc-number">3.</span><span class="post-toc-text">配置 gitlab pipeline 中的相关问题与处理</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#artifacts-%E4%B8%8E-cache"><span class="post-toc-number">3.1.</span><span class="post-toc-text">artifacts 与 cache</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#build-docker-%E9%95%9C%E5%83%8F"><span class="post-toc-number">3.2.</span><span class="post-toc-text">build docker 镜像</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#git-ssh-%E9%89%B4%E6%9D%83"><span class="post-toc-number">3.3.</span><span class="post-toc-text">git ssh 鉴权</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="post-toc-number">4.</span><span class="post-toc-text">参考文档</span></a></li></ol></nav></aside><article id="post-基于阿里云ACK-Serverless搭建按量付费的gitlab-runner" class="post-article article-type-post fade" itemprop="blogPost"><div class="post-card"><h1 class="post-card-title">基于阿里云ACK Serverless搭建按量付费的gitlab-runner</h1><div class="post-meta"><time class="post-time" title="2024-07-28 21:42:01" datetime="2024-07-28T13:42:01.000Z" itemprop="datePublished">2024-07-28</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/practice/">实践总结</a></li></ul><span id="container_page_pv" title="文章总阅读量" style="display:none"><span class="iconfont icon-eye" style="margin-right:5px;font-size:12px"></span><span id="value_page_pv"></span></span></div><div class="post-content" id="post-content" itemprop="postContent"><h2 id="方案说明"><a href="#方案说明" class="headerlink" title="方案说明"></a>方案说明</h2><p>◆ 由于 CI&#x2F;CD 的非持续运行而运行期间又需要较高系统资源的特性，符合 ACK Serverless 按资源使用时间计费的场景，降低 CI&#x2F;CD 成本的同时又能提高并行多任务的执行效率。<br>◆ 方案的系统结构与流程如下面来自参考文档[1]的截图，当没有任务时仅 gitlab-runner 作为一个 pod 始终运行，以随时接受来自 gitlab 的任务分配。当有任务需要执行时，针对每个任务创建一个 kubernetes executor 类型的 pod 执行任务，且任务执行结束后，这些 kubernetes executor 类型的 pod 会自动销毁。</p><div class="img-container" style="width:87%"><img src="/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/structure_and_process.png" class="" onerror="imgOnError(this)" data-fancybox></div><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="准备-ACK-Serverless-集群环境"><a href="#准备-ACK-Serverless-集群环境" class="headerlink" title="准备 ACK Serverless 集群环境"></a>准备 ACK Serverless 集群环境</h3><p>● 在阿里云工作台页面创建 ACK Serverless 类型的 kubernetes 集群。<br>● 根据&quot;集群信息&quot;中的&quot;连接信息&quot;，配置本地 kubectl，使可以在本地 kubectl 上对集群做操作。</p><h3 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h3><p>◇ 从 GitHub 上 clone 由参考文档[1]提供的<a target="_blank" rel="noopener" href="https://github.com/aliyuneci/BestPractice-Serverless-Kubernetes">配置文件样例</a>到本地，使用其中&quot;eci-gitlab-runner&quot;文件夹里的配置文件。<br>◇ 以下配置的内容最终将集中到 config-map.yml 并经由集群的 deployment 被 mount 到 config.toml 文件，以方便地应用到所部署的 gitlab-runner pod 中。<br>◇ 未来由 gitlab-runner 拉起的 kubernetes executor 类型 pod 的配置也在这个 config.toml 文件里的，部分配置也会被 mount 成 pod 中的文件。<br>◇ 以下配置内容和命令中的所有由&quot;${}&quot;包裹的变量都需要替换成实际值。</p><h4 id="secret"><a href="#secret" class="headerlink" title="secret"></a>secret</h4><p>◆ 通过 secret 存放 kubernetes 集群、docker registry、git ssh 的鉴权信息。<br>◆ 修改样例 secret.yaml 配置，其中的 ca.crt、tls.crt、tls.key 依次填写集群连接信息里的 certificate-authority-data、client-certificate-data、client-key-data。<br>◆ 执行&quot;kubectl apply -f secret.yaml&quot;使生效。secret.yaml 完整内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-runner-secret</span><br><span class="line">type: kubernetes.io/tls</span><br><span class="line">data:</span><br><span class="line">  ca.crt: $&#123;ca.crt&#125;</span><br><span class="line">  tls.crt: $&#123;tls.crt&#125;</span><br><span class="line">  tls.key: $&#123;tls.key&#125;</span><br></pre></td></tr></table></figure><p>◆ 如果 gitlab 的 pipeline 任务需要推送 docker 镜像到镜像仓库，则在集群创建名为&quot;registry-auth-secret&quot;的 secret，执行如下命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry registry-auth-secret --docker-server=$&#123;registry-server-hostname&#125; --docker-username=$&#123;username&#125; --docker-password=$&#123;password&#125;</span><br></pre></td></tr></table></figure><p>◆ 如果 gitlab 的 pipeline 任务需要 clone 其他 git 仓库，则在集群创建名为&quot;gitlab-credentials&quot;的 secret，执行如下命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic gitlab-credentials --from-file=id_rsa=$&#123;pathto_id_rsa&#125; --from-file=id_rsa.pub=$&#123;pathto_id_rsa.pub&#125; --from-file=known_hosts=$&#123;pathto_known_hosts&#125;</span><br></pre></td></tr></table></figure><p>◆ secret 创建成功后可在&quot;阿里云工作台页面集群详情-&gt;配置管理-&gt;保密字典&quot;位置看到。</p><div class="img-container" style="width:50%"><img src="/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/secret_in_workbench.png" class="" onerror="imgOnError(this)" data-fancybox></div><h4 id="配置-cache"><a href="#配置-cache" class="headerlink" title="配置 cache"></a>配置 cache</h4><p>● gitlab 的 cache 用于让 executor 缓存文件与文件夹以减少重复的下载、安装等工作。<br>● executor 容器的 cache 存储到的默认路径是&quot;&#x2F;cache&quot;，样例已经在 config-map.yaml 中将 pvc 配置到了此路径。</p><div class="img-container" style="width:50%"><img src="/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/cache_path_in_configmap.png" class="" onerror="imgOnError(this)" data-fancybox></div><p>● 准备好 NAS(Network Attached Storage) 盘，将其地址与缓存文件夹根目录(此处定义为&#x2F;gitlab-runner-cache)填写到 nas-pv.yaml。nas-pv.yaml 完整内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-runner-cache-pv</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  mountOptions:</span><br><span class="line">  - nolock,noresvport,noacl,hard</span><br><span class="line">  - vers=3</span><br><span class="line">  - rsize=1048576</span><br><span class="line">  - wsize=1048576</span><br><span class="line">  - proto=tcp</span><br><span class="line">  - timeo=600</span><br><span class="line">  - retrans=2</span><br><span class="line">  nfs:</span><br><span class="line">    path: /gitlab-runner-cache</span><br><span class="line">    server: $&#123;nas-server&#125;</span><br></pre></td></tr></table></figure><p>● 相应的 nas-pvc.yaml 直接使用样例的即可。nas-pvc.yaml 完整内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-runner-cache-pvc</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 10Gi</span><br><span class="line">  volumeName: gitlab-runner-cache-pv</span><br></pre></td></tr></table></figure><p>● 分别执行&quot;kubectl apply -f nas-pv.yaml&quot;和&quot;kubectl apply -f nas-pvc.yaml&quot;使生效。<br>◆ pv 与 pvc 创建成功后可分别在&quot;阿里云工作台页面集群详情-&gt;存储-&gt;存储卷|存储声明&quot;位置看到。</p><div class="img-container" style="width:80%"><img src="/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/pv_and_pvc_in_workbench.png" class="" onerror="imgOnError(this)" data-fancybox></div><h4 id="配置-image-cache"><a href="#配置-image-cache" class="headerlink" title="配置 image-cache"></a>配置 image-cache</h4><p>○ imagecache-crd(Custom Resource Definition，CRD)是用于实现镜像缓存的 kubernetes 控制器，样例在 config-map.yaml 和 gitlab-runner-deployment.yaml 中通过 k8s.aliyun.com&#x2F;eci-image-cache 这个自定义注解标识了对 imagecache 的启用。</p><div class="img-container" style="width:65%"><img src="/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/imagecache_in_configmap.png" class="" onerror="imgOnError(this)" data-fancybox></div><div class="img-container" style="width:50%"><img src="/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/imagecache_in_deployment.png" class="" onerror="imgOnError(this)" data-fancybox></div><p>○ 通过&quot;kubectl get crd&quot;命令查看 imagecache-crd 是否已安装。如果未安装则通过&quot;kubectl apply -f imagecache-crd.yaml&quot;安装。直接使用样例的 imagecache-crd.yaml 即可，完整内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apiextensions.k8s.io/v1beta1</span><br><span class="line">kind: CustomResourceDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: imagecaches.eci.alibabacloud.com</span><br><span class="line">spec:</span><br><span class="line">  group: eci.alibabacloud.com</span><br><span class="line">  version: v1</span><br><span class="line">  names:</span><br><span class="line">    kind: ImageCache</span><br><span class="line">    plural: imagecaches</span><br><span class="line">    shortNames:</span><br><span class="line">    - ic</span><br><span class="line">    categories:</span><br><span class="line">    - all</span><br><span class="line">  scope: Cluster</span><br><span class="line">  subresources:</span><br><span class="line">    status: &#123;&#125;</span><br><span class="line">  validation:</span><br><span class="line">    openAPIV3Schema:</span><br><span class="line">      required:</span><br><span class="line">      - spec</span><br><span class="line">      properties:</span><br><span class="line">        spec:</span><br><span class="line">          type: object</span><br><span class="line">          required:</span><br><span class="line">          - images</span><br><span class="line">          properties:</span><br><span class="line">            imagePullSecrets:</span><br><span class="line">              type: array</span><br><span class="line">              items:</span><br><span class="line">                type: string</span><br><span class="line">            images:</span><br><span class="line">              minItems: 1</span><br><span class="line">              type: array</span><br><span class="line">              items:</span><br><span class="line">                type: string</span><br><span class="line">            imageCacheSize:</span><br><span class="line">              type: integer</span><br><span class="line">  additionalPrinterColumns:</span><br><span class="line">  - name: Age</span><br><span class="line">    type: date</span><br><span class="line">    JSONPath: .metadata.creationTimestamp</span><br><span class="line">  - name: CacheId</span><br><span class="line">    type: string</span><br><span class="line">    JSONPath: .status.imageCacheId</span><br><span class="line">  - name: Phase</span><br><span class="line">    type: string</span><br><span class="line">    JSONPath: .status.phase</span><br><span class="line">  - name: Progress</span><br><span class="line">    type: string</span><br><span class="line">    JSONPath: .status.progress</span><br></pre></td></tr></table></figure><p>○ 根据实际需要将待缓存的 docker 镜像名填写到 imagecache.yaml 中，我使用的 imagecache.yaml 完整内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: eci.alibabacloud.com/v1</span><br><span class="line">kind: ImageCache</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-runner</span><br><span class="line">spec:</span><br><span class="line">  images:</span><br><span class="line">  - gitlab/gitlab-runner-helper:x86_64-latest</span><br><span class="line">  - gitlab/gitlab-runner:latest</span><br><span class="line">  - node:20-alpine</span><br><span class="line">  - node:20</span><br><span class="line">  - mcr.microsoft.com/playwright:v1.44.0-jammy</span><br><span class="line">  - gcr.io/kaniko-project/executor:v1.14.0-debug</span><br></pre></td></tr></table></figure><p>○ 执行&quot;kubectl apply -f imagecache.yaml&quot;使生效。<br>○ imagecache 创建成功后可在&quot;阿里云工作台页面集群详情-&gt;工作负载-&gt;自定义资源-&gt;资源对象浏览器&quot;位置看到。</p><div class="img-container" style="width:80%"><img src="/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/imagecache_in_workbench.png" class="" onerror="imgOnError(this)" data-fancybox></div><h4 id="配置-ConfigMap"><a href="#配置-ConfigMap" class="headerlink" title="配置 ConfigMap"></a>配置 ConfigMap</h4><p>◇ gitlab-runner 的配置文件在容器虚拟机的默认位置是&quot;&#x2F;etc&#x2F;gitlab-runner&#x2F;config.toml&quot;，样例已经在 gitlab-runner-deployment.yaml 中将 configMap 的 mountPath 配置到了&#x2F;etc&#x2F;gitlab-runner。<br>◇ 参照<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/runners/runners_scope.html">gitlab 文档</a>得到 authentication token(注意不能是 registration token)填写到 config-map.yaml。<br>◇ 将私有 gitlab 网站与 kubernetes 集群的连接信息填写到 config-map.yaml 文件样例。其中 concurrent 控制支持同时执行任务的数量，由于 Serverless 特性可以认为不受限制。然后 executor 的 cpu 与内存配置通过 cpu_limit、cpu_request、memory_limit、memory_request 控制。<br>◇ config.toml 中有关 [runners.kubernetes] 配置项的说明也在<a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/executors/kubernetes/index.html">gitlab 文档</a>。<br>◇ config-map.yaml 完整内容如下。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-runner-config</span><br><span class="line">data:</span><br><span class="line">  config.toml: |</span><br><span class="line">    concurrent = 10</span><br><span class="line">    check_interval = 0</span><br><span class="line">    [[runners]]</span><br><span class="line">      name = &quot;runner-on-k8s&quot;</span><br><span class="line">      url = $&#123;gitlab-url&#125;</span><br><span class="line">      token = $&#123;authentication token&#125;</span><br><span class="line">      executor = &quot;kubernetes&quot;</span><br><span class="line">      output_limit = 51200</span><br><span class="line">      [runners.kubernetes]</span><br><span class="line">        host = $&#123;k8s-connect-url&#125;</span><br><span class="line">        cert_file = &quot;/etc/gitlab-runner/tls.crt&quot;</span><br><span class="line">        key_file = &quot;/etc/gitlab-runner/tls.key&quot;</span><br><span class="line">        ca_file = &quot;/etc/gitlab-runner/ca.crt&quot;</span><br><span class="line">        namespace = &quot;default&quot;</span><br><span class="line">        pull_policy = &quot;if-not-present&quot;</span><br><span class="line">        cpu_limit = &quot;2&quot;</span><br><span class="line">        cpu_request = &quot;2&quot;</span><br><span class="line">        memory_limit = &quot;4Gi&quot;</span><br><span class="line">        memory_request = &quot;4Gi&quot;</span><br><span class="line">        helper_cpu_limit = &quot;0.5&quot;</span><br><span class="line">        helper_cpu_request = &quot;0.5&quot;</span><br><span class="line">        helper_memory_limit = &quot;1Gi&quot;</span><br><span class="line">        helper_memory_request  = &quot;1Gi&quot;</span><br><span class="line">        helper_image = &quot;gitlab/gitlab-runner-helper:x86_64-latest&quot;</span><br><span class="line">        [runners.kubernetes.pod_annotations]</span><br><span class="line">          &quot;k8s.aliyun.com/eci-image-cache&quot; = &quot;true&quot;</span><br><span class="line">        [runners.kubernetes.volumes]</span><br><span class="line">          [[runners.kubernetes.volumes.pvc]]</span><br><span class="line">            name = &quot;gitlab-runner-cache-pvc&quot;</span><br><span class="line">            mount_path = &quot;/cache&quot;</span><br><span class="line">            readonly = false</span><br><span class="line">          [[runners.kubernetes.volumes.secret]]</span><br><span class="line">            name = &quot;registry-auth-secret&quot;</span><br><span class="line">            mount_path = &quot;/kaniko/.docker&quot;</span><br><span class="line">            read_only = true</span><br><span class="line">            [runners.kubernetes.volumes.secret.items]</span><br><span class="line">              &quot;.dockerconfigjson&quot; = &quot;config.json&quot;</span><br><span class="line">          [[runners.kubernetes.volumes.secret]]</span><br><span class="line">            name = &quot;gitlab-credentials&quot;</span><br><span class="line">            mount_path = &quot;/root/gitlab-credentials&quot;</span><br><span class="line">            read_only = true</span><br></pre></td></tr></table></figure><p>◇ 执行&quot;kubectl apply -f config-map.yaml&quot;使生效。<br>◇ ConfigMap 创建成功后可在&quot;阿里云工作台页面集群详情-&gt;配置管理-&gt;配置项&quot;位置看到。</p><div class="img-container" style="width:50%"><img src="/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/configmap_in_workbench.png" class="" onerror="imgOnError(this)" data-fancybox></div><h3 id="使用-deployment-部署-gitlab-runner-集群"><a href="#使用-deployment-部署-gitlab-runner-集群" class="headerlink" title="使用 deployment 部署 gitlab-runner 集群"></a>使用 deployment 部署 gitlab-runner 集群</h3><p>◆ 用于部署集群的 deployment 直接使用样例的 gitlab-runner-deployment.yaml 即可，完整内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-runner</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: gitlab-runner</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: gitlab-runner</span><br><span class="line">      annotations:</span><br><span class="line">        k8s.aliyun.com/eci-image-cache: &quot;true&quot;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: gitlab/gitlab-runner:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: gitlab-runner</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/gitlab-runner</span><br><span class="line">          name: config</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        projected:</span><br><span class="line">          defaultMode: 420</span><br><span class="line">          sources:</span><br><span class="line">          - secret:</span><br><span class="line">              items:</span><br><span class="line">              - key: ca.crt</span><br><span class="line">                path: ca.crt</span><br><span class="line">              - key: tls.crt</span><br><span class="line">                path: tls.crt</span><br><span class="line">              - key: tls.key</span><br><span class="line">                path: tls.key</span><br><span class="line">              name: gitlab-runner-secret</span><br><span class="line">          - configMap:</span><br><span class="line">              items:</span><br><span class="line">              - key: config.toml</span><br><span class="line">                path: config.toml</span><br><span class="line">              name: gitlab-runner-config</span><br></pre></td></tr></table></figure><p>◆ 执行&quot;kubectl apply -f gitlab-runner-deployment.yaml&quot;完成 gitlab-runner 的部署。<br>◆ 部署成功后可在&quot;阿里云工作台页面集群详情-&gt;工作负载-&gt;容器组&quot;位置看到 gitlab-runner 的 pod。接下来在私有 gitlab 网站配置好 runner，当有 pipeline 任务执行时也可以看到相应 executor 的 pod。</p><div class="img-container" style="width:60%"><img src="/practice/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91ACK-Serverless%E6%90%AD%E5%BB%BA%E6%8C%89%E9%87%8F%E4%BB%98%E8%B4%B9%E7%9A%84gitlab-runner/pods_in_workbench.png" class="" onerror="imgOnError(this)" data-fancybox></div><h2 id="配置-gitlab-pipeline-中的相关问题与处理"><a href="#配置-gitlab-pipeline-中的相关问题与处理" class="headerlink" title="配置 gitlab pipeline 中的相关问题与处理"></a>配置 gitlab pipeline 中的相关问题与处理</h2><h3 id="artifacts-与-cache"><a href="#artifacts-与-cache" class="headerlink" title="artifacts 与 cache"></a>artifacts 与 cache</h3><p>♂ artifacts 与 cache 的区别在 gitlab 文档(https://docs.gitlab.com/ee/ci/caching/#how-cache-is-different-from-artifacts)里有说明。<br>♂ 当前 gitlab-runner 的方案中，考虑到 artifacts 存储位置是 gitlab 所在远程主机，而 cache 存储位置在每个 executor 的本地磁盘(通过将 NAS 挂载到每个 executor 上实现了 cache 内容的共享)，特别当需缓存内容比较大的时候，使用 cache 优于 artifacts。<br>♂ cache 没有 artifacts 那样的自动过期删除机制，对于打包结果这种每次存储路径不同的 cache，可在 after_script 阶段增加脚本以针对 cache key 清理不再使用的 cache 内容。示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">.dist-cache: &amp;dist-cache</span><br><span class="line">  key: $CI_PIPELINE_ID</span><br><span class="line">  paths:</span><br><span class="line">    - ./dist</span><br><span class="line"></span><br><span class="line">stages:</span><br><span class="line">  - build</span><br><span class="line">  - deploy</span><br><span class="line"></span><br><span class="line">build-job:</span><br><span class="line">  stage: build</span><br><span class="line">  script:</span><br><span class="line">    - echo &#x27;build&#x27;;</span><br><span class="line">  cache:</span><br><span class="line">    - &lt;&lt;: *dist-cache</span><br><span class="line">      policy: pull-push</span><br><span class="line">  allow_failure: false</span><br><span class="line"></span><br><span class="line">deploy-job:</span><br><span class="line">  stage: deploy</span><br><span class="line">    image:</span><br><span class="line">    name: gcr.io/kaniko-project/executor:v1.14.0-debug</span><br><span class="line">    entrypoint: [&#x27;&#x27;]</span><br><span class="line">  script:</span><br><span class="line">    - echo &#x27;build and push docker image based on cache&#x27;;</span><br><span class="line">  after_script:</span><br><span class="line">    - rm -rf /cache/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID*;</span><br><span class="line">  cache:</span><br><span class="line">    - &lt;&lt;: *dist-cache</span><br><span class="line">      policy: pull</span><br><span class="line">  dependencies: [build-job]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="build-docker-镜像"><a href="#build-docker-镜像" class="headerlink" title="build docker 镜像"></a>build docker 镜像</h3><p>♀ 对于 docker 镜像的构建与推送，采用配置更简单的 kaniko 方式，根据参考文档[3]，已经在之前 ConfigMap 中配置 docker 仓库 secret 的 mountPath 到&quot;&#x2F;kaniko&#x2F;.docker&#x2F;config.json&quot;。<br>♀ kaniko 镜像是个特别精简的 linux，不适合在其中配置打包环境。于是将打包与 docker 操作拆分到不同 job，打包结果通过上步 cache 的方式共享到 kaniko 镜像对应的容器中。<br>♀ 使用 kaniko 的 deploy-job 的示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.echo-variables: &amp;echo-variables</span><br><span class="line">  - echo &quot;CI_PIPELINE_ID:&quot; $CI_PIPELINE_ID;</span><br><span class="line"></span><br><span class="line">deploy-job:</span><br><span class="line">  stage: deploy</span><br><span class="line">  image:</span><br><span class="line">    name: gcr.io/kaniko-project/executor:v1.14.0-debug</span><br><span class="line">    entrypoint: [&#x27;&#x27;]</span><br><span class="line">  script:</span><br><span class="line">    - /kaniko/executor</span><br><span class="line">      --context &quot;$&#123;CI_PROJECT_DIR&#125;&quot;</span><br><span class="line">      --dockerfile &quot;./Dockerfile&quot;</span><br><span class="line">      --destination &quot;$&#123;registry_dist&#125;&quot;</span><br><span class="line">  before_script:</span><br><span class="line">    - *echo-variables</span><br><span class="line">  after_script:</span><br><span class="line">    - rm -rf /cache/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID*;</span><br><span class="line">  cache:</span><br><span class="line">    - &lt;&lt;: *dist-cache</span><br><span class="line">      policy: pull</span><br><span class="line">  dependencies: [build-job]</span><br></pre></td></tr></table></figure><h3 id="git-ssh-鉴权"><a href="#git-ssh-鉴权" class="headerlink" title="git ssh 鉴权"></a>git ssh 鉴权</h3><p>▲ git ssh 信息的 mountPath 直接指定到&quot;&#x2F;root&#x2F;.ssh&quot;的时候遇到了如下问题：<br>（1）gitlab-runner 的 config.toml 配置中[runners.kubernetes.volumes.secret]不支持指定 mout 文件的 mode，使用 id_rsa 文件做 ssh 鉴权会报错：&quot;Permissions 0644 for &#39;&#x2F;root&#x2F;.ssh&#x2F;id_rsa&#39; are too open. This private key will be ignored&quot;。<br>（2）即使将配置中[runners.kubernetes.volumes.secret]的 read_only 设置为 false，对 id_rsa 执行 chmod 操作也报错&quot;chmod: changing permissions of &#39;&#x2F;root&#x2F;.ssh&#x2F;id_rsa&#39;: Read-only file system&quot;。<br>▲ 于是在 ConfigMap 中将 mountPath 指定到了&quot;&#x2F;root&#x2F;gitlab-credentials&quot;，之后在 pipeline 里再将文件从&quot;&#x2F;root&#x2F;gitlab-credentials&quot;拷贝到&quot;&#x2F;root&#x2F;.ssh&quot;并设置文件 mode。<br>▲ 如下示例定义一个初始化 git 鉴权文件的锚点供需要时引用。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.prepare-git: &amp;prepare-git</span><br><span class="line">  - set +e;cat /root/.ssh/known_hosts;if [[ $? -ne 0 ]]; then</span><br><span class="line">    mkdir /root/.ssh;cat /root/gitlab-credentials/id_rsa &gt; /root/.ssh/id_rsa;chmod 400 /root/.ssh/id_rsa;</span><br><span class="line">    cp /root/gitlab-credentials/id_rsa.pub /root/gitlab-credentials/known_hosts /root/.ssh/;</span><br><span class="line">    fi;set -e;</span><br><span class="line">  - ssh -T git@$&#123;git_domain&#125;</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ol><li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/773024?spm=a2c6h.13066369.question.5.3f623d588KEIEN">从零入门 Serverless | 教你 7 步快速构建 GitLab 持续集成环境</a></li><li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/">gitlab 官方 doc</a></li><li><a target="_blank" rel="noopener" href="https://www.pachamamita.de/posts/kubernetes/kaniko-gitlab-runner/">kubernetes executor 上支持 docker 命令</a></li></ol></div><blockquote class="post-copyright"><div class="content"></div><footer style="width:100%"><h5><span class="post-time">最后更新时间：<time datetime="2025-03-19T13:37:34.701Z" itemprop="dateUpdated">2025-03-19 21:37:34</time></span><span style="float:right"><img src="/img/avatar.jpg" alt="Congzhou">Congzhou</span></h5></footer></blockquote><div class="post-footer"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ACK-Serverless/" rel="tag">ACK Serverless</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gitlab/" rel="tag">gitlab</a></li></ul></div></div><nav class="post-nav flex-row flex-justify-between"><div class="prev"><a href="/practice/%E5%9F%BA%E4%BA%8Everdaccio%E7%9A%84npm%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93.html" id="post-prev" class="post-nav-link"><div class="tips"><i class="iconfont icon-arrow1l"></i>Prev</div><h4 class="title">基于verdaccio的npm私有仓库</h4></a></div><div class="next"><a href="/knowledge/State-of-GPT-%E7%90%86%E8%A7%A3.html" id="post-next" class="post-nav-link"><div class="tips">Next<i class="iconfont icon-arrow1r"></i></div><h4 class="title">&lt;State of GPT&gt;理解</h4></a></div></nav><div class="comments vcomment" id="comments"></div><script src="/js/valine.min.js"></script><script>var GUEST_INFO=["nick","mail","link"],guest_info="nick,mail,link".split(",").filter(function(e){return-1<GUEST_INFO.indexOf(e)}),required_info="nick,mail".split(",").filter(function(e){return-1<GUEST_INFO.indexOf(e)});new Valine({el:"#comments",appId:"tq4lHkryFNXHsw9SOypjPRwx-gzGzoHsz",appKey:"lFmuObNsezjTPj5e86R1TgOg",avatar:"mp",placeholder:"欢迎留言(支持Markdown语法), 将展示您邮箱绑定的Gravatar头像(如果有的话~)",meta:0==guest_info.length?GUEST_INFO:guest_info,pageSize:"10",recordIP:!1,requiredFields:required_info})</script></article></div><footer class="footer"><div class="bottom"><p><span>Copyright &copy; 2009-2025 Congzhou</span><span id="container_site_uv" style="display:none">总访客数：<span id="value_site_uv"></span></span><span id="container_site_pv" style="display:none">总访问量：<span id="value_site_pv"></span></span></p></div></footer></main><div class="mask" id="mask"></div><a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light" style="text-decoration:none"><span class="iconfont icon-arrow-up" style="font-size:25px;font-weight:700"></span></a><script>var BLOG={ROOT:"/",SHARE:!1,REWARD:!1}</script><script src="/js/main.min.js"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><template id="search-tpl"><li class="item"><a href="{path}" class="waves-block waves-effect"><div class="title ellipsis" title="{title}">{title}</div><div class="flex-row flex-middle"><div class="tags ellipsis">{tags}</div><time class="flex-col time">{date}</time></div></a></li></template><script src="/js/search.min.js"></script><script>Observer.callback=function(){var e=document.querySelector("#value_page_pv");e.innerText=VISIT_INFO.curPagePV,e.parentNode.style.display="inline-block"},VISIT_INFO.curPagePV,Observer.callback=null,Observer.callback=function(){var e=document.querySelector("#value_site_pv");e.innerText=VISIT_INFO.totalPV,e.parentNode.style.display="inline-block"},VISIT_INFO.totalPV,Observer.callback=null,Observer.callback=function(){var e=document.querySelector("#value_site_uv");e.innerText=VISIT_INFO.totalUV,e.parentNode.style.display="inline-block"},VISIT_INFO.totalUV,Observer.callback=null,setTimeout(function(){var a=AV.Object.extend("visit_pv"),e=AV.Object.extend("visit_uv"),t=new AV.Query(a),o=location.pathname;location.hostname.match("localhost")?(t.equalTo("url",o),t.find().then(function(e){if(e.length){var t=e[0];VISIT_INFO.curPagePV=t.get("times")}else VISIT_INFO.curPagePV=0})):(t.equalTo("url",o),t.find().then(function(e){if(e.length){var t=e[0];VISIT_INFO.curPagePV=t.get("times"),t.increment("times",1),t.save()}else{VISIT_INFO.curPagePV=0;var l=new a;l.set("url",o),l.set("times",1);var n=document.querySelector(".post-card-title").innerText;l.set("title",n),l.save()}}));var l=localStorage.getItem("blog_UID");l||(l=generateUID(),localStorage.setItem("blog_UID",l)),AV.Cloud.run("total_pv").then(function(e){VISIT_INFO.totalPV=e}),location.hostname.match("localhost")||AV.Cloud.run("rec_uv",{UID:l}).then(function(e){}),new AV.Query(e).count().then(function(e){VISIT_INFO.totalUV=e+1998})},100)</script><script>"serviceWorker"in navigator&&(window.addEventListener("load",function(){navigator.serviceWorker.register("/service-worker.js").then(function(e){console.log("service-worker register ok")}).catch(function(e){console.log("service-worker register failed: "+e)})}),navigator.serviceWorker.addEventListener("controllerchange",function(){console.log("检测到缓存资源更新，刷新以获取新内容")}))</script></body></html>